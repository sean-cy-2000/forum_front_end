<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文章詳情</title>
    <!-- 引入必要的函式庫 -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/dayjs.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="./style.css">
    <script src="./side.js"></script>
</head>

<body>
    <!-- 整體容器 -->
    <div class="container">
        <!-- 主要內容區 -->
        <div class="main-content">
            <!-- 文章區塊：使用最簡化的結構 -->
            <div class="post-area">
                <h1></h1>
                <div class="info">
                    <span class="author"></span>
                    <button class="interaction-btn" id="likeBtn">
                        <i class="fa-regular fa-thumbs-up"></i>
                        <span>0</span>
                    </button>
                    <button class="interaction-btn" id="collectBtn">
                        <i class="fa-regular fa-bookmark"></i>
                        <span>0</span>
                    </button>
                    <button class="interaction-btn" id="commentBtn">
                        <i class="fa-regular fa-comment-dots"></i>
                        <span>0</span>
                    </button>
                    <span class="date"></span>
                </div>
                <div class="tags"></div>
                <div class="content"></div>
            </div>

            <!-- 留言區 -->
            <div class="post-area">
                <h2>留言區</h2>
                <button id="addCommentBtn">發布留言</button>
                <div class="comments-list"></div>
            </div>
        </div>
    </div>

    <script>
        // API 配置：設定基本的 axios 實例
        const api = axios.create({
            baseURL: 'http://localhost:3000',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        // 全局變量
        let currentPostId = '';
        let isLoggedIn = false;

        // 頁面初始化
        $(document).ready(async function () {
            // 插入側邊欄並初始化頁面內容
            $('.container').prepend(createSidebar());
            isLoggedIn = await getUserInfo();
            await initializePost();
            await getLevel_0_Comments();

            // 綁定交互按鈕事件
            $('#likeBtn').click(handleLike);
            $('#collectBtn').click(handleCollect);
            $('#commentBtn').click(() => {
                $('.comments-section')[0].scrollIntoView({ behavior: 'smooth' });
            });
            $('#addCommentBtn').click(() => checkLoginAndComment('post', currentPostId));
        });

        // 初始化文章內容
        async function initializePost() {
            try {
                currentPostId = new URLSearchParams(window.location.search).get('id');
                if (!currentPostId) {
                    alert('文章ID不存在');
                    window.location.href = './index.html';
                    return;
                }

                const headers = localStorage.getItem('token')
                    ? { Authorization: `Bearer ${localStorage.getItem('token')}` }
                    : {};
                const { data: { post } } = await api.get(`/post/getPostInfo/${currentPostId}`, { headers });

                // 更新頁面上的文章內容
                updatePostContent(post);
            } catch (error) {
                console.error('獲取文章失敗:', error);
                alert('獲取文章失敗');
            }
        }

        // 更新文章內容到頁面
        function updatePostContent(post) {
            // 使用正確的選擇器 .post-area，並選擇第一個元素（文章區塊）
            const $post = $('.post-area').first();
            $post.find('h1').text(post.title);
            $post.find('.author').text(`作者: ${post.postOwnerAccount}`);
            $post.find('.date').text(`發表時間: ${dayjs(post.createdAt).format('YYYY-MM-DD HH:mm')}`);
            $post.find('.content').text(post.content);

            // 更新互動按鈕計數
            $('#likeBtn span').text(post.likersCount);
            $('#collectBtn span').text(post.collectorsCount);
            $('#commentBtn span').text(post.commentsCount);

            // 設置互動狀態
            if (isLoggedIn) {
                if (post.isLiked) {
                    $('#likeBtn').addClass('active').find('i')
                        .removeClass('fa-regular').addClass('fa-solid');
                }
                if (post.isCollected) {
                    $('#collectBtn').addClass('active').find('i')
                        .removeClass('fa-regular').addClass('fa-solid');
                }
            }

            // 更新標籤列表
            const $tags = $('.tags').empty();
            post.tags?.forEach(tag => {
                $tags.append($('<span>').addClass('tag').text(`#${tag}`));
            });
        }
        // 處理點讚功能
        async function handleLike() {
            if (!checkLogin()) return;

            try {
                await api.post(`/post/addLike/post/${currentPostId}`, {}, {
                    headers: { Authorization: `Bearer ${localStorage.getItem('token')}` }
                });

                const $btn = $('#likeBtn');
                const $icon = $btn.find('i');
                const $count = $btn.find('span');

                toggleButtonState($btn, $icon, $count);
            } catch (error) {
                console.error('點讚失敗:', error);
                alert('點讚失敗');
            }
        }

        // 處理收藏功能
        async function handleCollect() {
            if (!checkLogin()) return;

            try {
                const response = await api.post(`/post/addCollect/${currentPostId}`, {}, {
                    headers: { Authorization: `Bearer ${localStorage.getItem('token')}` }
                });

                const $btn = $('#collectBtn');
                const $icon = $btn.find('i');
                const $count = $btn.find('span');

                if (response.data.message === "取消收藏") {
                    $btn.removeClass('active');
                    $icon.removeClass('fa-solid').addClass('fa-regular');
                    $count.text(parseInt($count.text()) - 1);
                } else {
                    $btn.addClass('active');
                    $icon.removeClass('fa-regular').addClass('fa-solid');
                    $count.text(parseInt($count.text()) + 1);
                }
            } catch (error) {
                console.error('收藏失敗:', error);
                alert('收藏失敗');
            }
        }

        // 獲取頂層留言
        async function getLevel_0_Comments() {
            try {
                const response = await api.get(`/post/getLevel_0_Comments/${currentPostId}`);
                const comments = response.data.comments;

                // 檢查每個留言的子留言數量
                for (const comment of comments) {
                    try {
                        const childrenResponse = await api.get(`/post/getChildrenComments/${comment.id}`);
                        comment.hasChildren = childrenResponse.data.descendants.length > 0;
                        comment.childrenCount = childrenResponse.data.descendants.length;
                    } catch (error) {
                        comment.hasChildren = false;
                        comment.childrenCount = 0;
                    }
                }

                // 渲染留言列表
                $('.comments-list').html(
                    comments.map(comment => createCommentHTML(comment, 0)).join('')
                );
            } catch (error) {
                console.error('獲取留言失敗:', error);
                $('.comments-list').html('<p>獲取留言失敗</p>');
            }
        }

        // 創建留言HTML結構
        function createCommentHTML(comment, level) {
            const marginLeft = level * 20;
            const commentId = comment.id || comment._id;
            const commenterAccount = comment.commenterAccount ||
                (comment.commenterId && comment.commenterId.account);

            return `
                <div class="comment-item" id="comment-${commentId}" style="margin-left: ${marginLeft}px">
                    <div class="comment-header">
                        <span>${commenterAccount}</span>
                        <span>${dayjs(comment.editAt || comment.createdAt).format('YYYY-MM-DD HH:mm')}</span>
                    </div>
                    <div class="comment-content">
                        ${comment.content}
                    </div>
                    <div class="comment-footer">
                        ${comment.hasChildren ? `
                            <button class="interaction-btn" onclick="toggleChildren('${commentId}')">
                                <i class="fa-regular fa-comment-dots"></i>
                                <span>${comment.childrenCount}</span>
                            </button>
                        ` : ''}
                        ${level < 3 ? `
                            <button onclick="checkLoginAndComment('comment', '${commentId}')">回覆</button>
                        ` : ''}
                    </div>
                    <div class="nested-comments" id="children-${commentId}"></div>
                </div>
            `;
        }

        // 切換子留言顯示狀態
        async function toggleChildren(commentId) {
            const $childrenContainer = $(`#children-${commentId}`);
            const isLoaded = $childrenContainer.hasClass('active');

            if (isLoaded) {
                $childrenContainer.removeClass('active');
            } else {
                try {
                    const response = await api.get(`/post/getChildrenComments/${commentId}`);
                    const children = response.data.descendants;

                    if (children?.length) {
                        const parentLevel = parseInt($(`#comment-${commentId}`).css('margin-left')) / 20;
                        const nextLevel = parentLevel + 1;

                        $childrenContainer.html(
                            children.map(child => createCommentHTML(child, nextLevel)).join('')
                        );
                    }

                    $childrenContainer.addClass('active');
                } catch (error) {
                    console.error('獲取子留言失敗:', error);
                    $childrenContainer.html('<p>獲取子留言失敗</p>');
                }
            }
        }

        // 檢查登入狀態
        function checkLogin() {
            if (!isLoggedIn && confirm('請先登入')) {
                window.location.href = './login.html';
            }
            return isLoggedIn;
        }

        // 處理留言功能
        function checkLoginAndComment(type, id) {
            if (!checkLogin()) return;

            const width = 500;
            const height = 300;
            const left = (window.innerWidth - width) / 2;
            const top = (window.innerHeight - height) / 2;

            const url = type === 'post'
                ? `addComment.html?postId=${id}&parentCommentId=0`
                : `addComment.html?postId=${currentPostId}&parentCommentId=${id}`;

            window.open(
                url,
                'commentWindow',
                `width=${width},height=${height},left=${left},top=${top}`
            );
        }

        // 通用的按鈕狀態切換函數
        function toggleButtonState($btn, $icon, $count) {
            if ($btn.hasClass('active')) {
                $btn.removeClass('active');
                $icon.removeClass('fa-solid').addClass('fa-regular');
                $count.text(parseInt($count.text()) - 1);
            } else {
                $btn.addClass('active');
                $icon.removeClass('fa-regular').addClass('fa-solid');
                $count.text(parseInt($count.text()) + 1);
            }
        }
    </script>
</body>

</html>